<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKRAAM MASTER PRO v65.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; font-size: 16px; }
        @media print { 
            .no-print { display: none !important; } 
            body { background: white; font-size: 12pt; }
            .print-area { width: 100% !important; margin: 0; padding: 0; }
            table { width: 100% !important; border: 1px solid #000; }
            th, td { border: 1px solid #000 !important; padding: 8px; text-align: left; }
        }
        .amount-val { font-family: 'Courier New', monospace; font-weight: 900; letter-spacing: -1px; }
        .hidden-module { display: none !important; }
        .mode-btn-active { border: 2px solid #4f46e5; background: #eef2ff; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 pb-10">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center no-print shadow-2xl">
        <div class="flex items-center gap-3">
            <span class="bg-indigo-600 px-3 py-1 rounded-full font-black text-xs uppercase tracking-tighter">v65.0 PRO</span>
            <h1 id="navHeader" class="font-black uppercase text-sm italic text-indigo-300">IKRAAM LEDGER</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="askConfigPass()" class="bg-amber-600 px-3 py-2 rounded-xl text-[10px] font-black uppercase">Config</button>
            <button onclick="window.print()" class="bg-rose-600 px-3 py-2 rounded-xl text-[10px] font-black uppercase">Print</button>
            <button onclick="secureBackup()" class="bg-indigo-600 px-3 py-2 rounded-xl text-[10px] font-black uppercase">Backup</button>
            <button onclick="document.getElementById('importFile').click()" class="bg-teal-600 px-3 py-2 rounded-xl text-[10px] font-black uppercase">Import</button>
            <input type="file" id="importFile" class="hidden" onchange="importSecureJSON(event)">
        </div>
    </nav>

    <div id="passModal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center border-t-8 border-indigo-600">
            <h2 class="font-black uppercase text-lg mb-6 tracking-tighter text-slate-800">Admin Security</h2>
            <div class="relative mb-6">
                <input type="password" id="adminPassInput" placeholder="Password Dalein" class="w-full border-2 border-gray-200 p-4 rounded-2xl text-center font-black text-xl outline-none focus:border-indigo-600 transition-all">
                <button onclick="togglePassView('adminPassInput')" class="absolute right-4 top-4 text-gray-400">üëÅÔ∏è</button>
            </div>
            <button onclick="verifyConfigPass()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase shadow-xl hover:bg-indigo-700 active:scale-95 transition-all">Unlock System</button>
            <button onclick="closeModal('passModal')" class="mt-4 text-gray-400 font-bold uppercase text-xs">Cancel</button>
        </div>
    </div>

    <div id="configModal" class="fixed inset-0 bg-gray-50 z-[90] hidden flex flex-col no-print overflow-y-auto">
        <div class="bg-slate-900 p-5 text-white flex justify-between items-center">
            <h2 class="font-black uppercase text-sm tracking-widest text-indigo-400">Master Configuration Panel</h2>
            <button onclick="closeModal('configModal')" class="bg-rose-600 px-8 py-2 rounded-xl font-black text-xs">EXIT</button>
        </div>
        <div class="flex-1 p-6 container mx-auto grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="lg:col-span-2">
                <h3 class="font-black text-indigo-600 border-b-4 border-indigo-100 pb-2 uppercase text-sm mb-6">Rename & Control Modules</h3>
                <div id="configGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div class="space-y-6">
                <div class="bg-white p-8 rounded-[3rem] shadow-xl border-2 border-gray-100">
                    <h3 class="font-black text-gray-400 uppercase text-xs mb-6">System Identity</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="text-xs font-black text-gray-500 uppercase ml-2">App Name</label>
                            <input type="text" id="cfgAppTitle" class="w-full border-2 p-4 rounded-2xl font-black text-indigo-900 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="text-xs font-black text-rose-500 uppercase ml-2">Admin Password</label>
                            <div class="relative">
                                <input type="password" id="cfgAdminPass" class="w-full border-2 p-4 rounded-2xl font-black bg-rose-50 focus:border-rose-600">
                                <button onclick="togglePassView('cfgAdminPass')" class="absolute right-4 top-4">üëÅÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="saveConfig()" class="w-full bg-indigo-600 text-white py-6 rounded-[2.5rem] font-black uppercase shadow-2xl hover:bg-indigo-800 transition-all">Save All Changes</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 no-print">
            <div class="bg-white p-8 rounded-[3rem] shadow-2xl border-t-[12px] border-slate-900">
                <form id="mainForm" class="space-y-5">
                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-3">Date Selection</label>
                        <input type="date" id="tDate" required class="w-full border-2 border-gray-100 p-4 rounded-2xl font-black text-sm focus:border-indigo-500 outline-none shadow-sm">
                    </div>
                    
                    <input list="partyList" id="tParty" placeholder="Enter Name (Person/Unit)" required class="w-full border-2 border-gray-100 p-4 rounded-2xl font-black text-sm focus:border-indigo-500 outline-none shadow-sm">
                    
                    <select id="tCat" onchange="toggleVisitModule(this.value)" required class="w-full border-2 border-gray-100 p-4 rounded-2xl font-black text-sm bg-gray-50 focus:border-indigo-500 outline-none"></select>
                    
                    <div id="visitBox" class="bg-indigo-50 p-6 rounded-[2rem] hidden-module space-y-4 border-2 border-indigo-100 animate-pulse-once">
                        <p class="text-[10px] font-black text-indigo-600 uppercase italic">Visit Pro Details</p>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="vPurpose" placeholder="Purpose" class="w-full border p-3 rounded-xl font-bold text-xs outline-none">
                            <select id="vMode" class="w-full border p-3 rounded-xl font-bold text-xs bg-white outline-none">
                                <option value="Bike">Bike</option><option value="Car">Car</option><option value="Other">Other</option>
                            </select>
                        </div>
                        <input type="number" id="vMiscAmt" placeholder="Misc Expense (Add to Total)" class="w-full border p-3 rounded-xl font-bold text-xs focus:bg-white outline-none">
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-gray-400 uppercase ml-3">Payment Method</label>
                        <select id="tMode" required class="w-full border-2 border-gray-100 p-4 rounded-2xl font-black text-sm bg-gray-50 outline-none focus:border-indigo-500">
                            <option value="Cash">Naqad (Cash)</option>
                            <option value="Udhaar">Udhaar (Credit)</option>
                            <option value="EasyPaisa">EasyPaisa</option>
                            <option value="JazzCash">JazzCash</option>
                            <option value="NayaPay">NayaPay</option>
                            <option value="SadaPay">SadaPay</option>
                            <option value="Bank">Bank Transfer</option>
                        </select>
                    </div>

                    <textarea id="tDesc" placeholder="Entry ki detail likhein..." required class="w-full border-2 border-gray-100 p-4 rounded-2xl font-black text-sm h-20 outline-none focus:border-indigo-500"></textarea>
                    
                    <div class="bg-slate-900 p-6 rounded-[2rem] shadow-inner text-center">
                        <label class="text-[10px] text-gray-500 font-black uppercase tracking-[0.2em]">Enter Amount</label>
                        <input type="number" id="tAmount" placeholder="0.00" required class="w-full bg-transparent text-white font-black text-5xl text-center outline-none">
                    </div>
                    
                    <button type="submit" id="saveBtn" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase text-lg shadow-2xl hover:bg-indigo-800 transform active:scale-95 transition-all">Save Record</button>
                    <button type="button" onclick="resetForm()" id="cancelEdit" class="hidden w-full mt-2 bg-rose-50 py-3 rounded-xl text-rose-600 font-black uppercase border-2 border-rose-100">Cancel Edit</button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6 print-area">
            <div class="bg-white p-5 rounded-[2rem] shadow-xl border-2 border-indigo-100 no-print flex items-center gap-4">
                <span class="text-2xl">üîç</span>
                <input type="text" id="mSearch" oninput="render()" placeholder="Search: 'EasyPaisa Feb' or 'Shop Sale Udhaar'..." class="w-full outline-none font-black text-sm uppercase text-indigo-900 placeholder-indigo-200">
            </div>

            <div id="dash" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>

            <div class="bg-white rounded-[2.5rem] shadow-2xl border-2 border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900 text-white text-[11px] font-black uppercase italic tracking-widest">
                            <tr>
                                <th class="p-5">Date/Ref</th>
                                <th class="p-5">Details</th>
                                <th class="p-5 text-center">Category</th>
                                <th class="p-5 text-right">Amount</th>
                                <th class="p-5 no-print text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tBody" class="text-sm font-bold divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <datalist id="partyList"></datalist>

    <script>
        // CORE CONFIGURATION
        const CODES = ["OFFICE-BILL", "INC-08", "INC-05", "EXP-03", "INC-01", "INC-04", "EXP-04", "EXP-05", "INC-07", "EXP-01"];
        const DEFAULTS = {
            labels: { "OFFICE-BILL": "Visit Kharcha", "INC-08": "Visit Wapsi", "INC-05": "Loan Lia", "EXP-03": "Loan Diya", "INC-01": "Dukan Sale", "INC-04": "Udhaar Wapsi", "EXP-04": "Udhaar Diya", "EXP-05": "Loss/Nuqsan", "INC-07": "Salary Mili", "EXP-01": "Ghar Kharcha" },
            visible: CODES.reduce((a, c) => ({...a, [c]: true}), {}),
            title: "IKRAAM MASTER PRO v65",
            adminPass: "admin786"
        };
        
        let db = { entries: [], parties: [], ...DEFAULTS };
        let editId = null;

        function init() {
            const saved = JSON.parse(localStorage.getItem('ikraam_v65_db'));
            if(saved) db = { ...DEFAULTS, ...saved };
            document.getElementById('navHeader').innerText = db.title;
            render();
        }

        function togglePassView(id) { const i = document.getElementById(id); i.type = i.type === "password" ? "text" : "password"; }
        function toggleVisitModule(val) { document.getElementById('visitBox').classList.toggle('hidden-module', val !== "OFFICE-BILL"); }

        function render() {
            updateCatDropdown();
            const tbody = document.getElementById('tBody'); tbody.innerHTML = '';
            const q = document.getElementById('mSearch').value.toLowerCase().split(' ').filter(x => x);
            let s = { cash: 0, off: 0, pay: 0, rec: 0 };

            db.entries.sort((a,b) => new Date(b.date) - new Date(a.date));
            db.entries.forEach(t => {
                const searchStr = `${t.party} ${t.desc} ${t.cat} ${t.date} ${t.mode} ${db.labels[t.cat]}`.toLowerCase();
                const isVisit = (t.cat === "OFFICE-BILL" || t.cat === "INC-08");
                const match = q.every(word => searchStr.includes(word) || (word === 'office' && isVisit));

                if(match) {
                    const amt = parseFloat(t.amount); const isInc = t.cat.startsWith("INC");
                    
                    // Dashboard Logic
                    if(t.mode !== "Udhaar") s.cash += (isInc ? amt : -amt);
                    if(t.cat === "INC-05") s.pay += amt; if(t.cat === "EXP-03") s.pay -= amt;
                    if(t.cat === "EXP-04") s.rec += amt; if(t.cat === "INC-04" || t.cat === "EXP-05") s.rec -= amt;
                    if(t.cat === "OFFICE-BILL") s.off += amt; if(t.cat === "INC-08") s.off -= amt;

                    tbody.innerHTML += `<tr class="hover:bg-indigo-50 transition-colors">
                        <td class="p-5 text-gray-400 font-normal">#${t.id.toString().slice(-4)}<br>${t.date}</td>
                        <td class="p-5 uppercase">
                            <div class="font-black text-slate-800">${t.party}</div>
                            <div class="text-[11px] text-gray-500 font-normal normal-case leading-tight mt-1">${t.desc}</div>
                        </td>
                        <td class="p-5 text-center">
                            <span class="bg-gray-100 px-2 py-1 rounded text-[9px] border font-black uppercase text-gray-600">${db.labels[t.cat] || t.cat}</span>
                            <div class="text-[10px] text-indigo-600 font-black mt-1">${t.mode}</div>
                        </td>
                        <td class="p-5 text-right font-black text-xl ${isInc?'text-emerald-700':'text-rose-700'} amount-val">${amt.toLocaleString()}</td>
                        <td class="p-5 text-center no-print">
                            <div class="flex gap-2 justify-center">
                                <button onclick="editEntry(${t.id})" class="bg-blue-100 p-2 rounded-lg text-blue-600 hover:bg-blue-600 hover:text-white">‚úé</button>
                                <button onclick="deleteEntry(${t.id})" class="bg-rose-100 p-2 rounded-lg text-rose-600 hover:bg-rose-600 hover:text-white">üóë</button>
                            </div>
                        </td>
                    </tr>`;
                }
            });
            document.getElementById('dash').innerHTML = `
                <div class="bg-white p-5 rounded-3xl border-b-8 border-slate-900 shadow-xl text-center"><p class="text-[10px] font-black text-gray-400 uppercase">Cash/Online Balance</p><h2 class="text-2xl font-black amount-val">${s.cash.toLocaleString()}</h2></div>
                <div class="bg-white p-5 rounded-3xl border-b-8 border-emerald-500 shadow-xl text-center"><p class="text-[10px] font-black text-emerald-500 uppercase">Leina Hai (Udhaar)</p><h2 class="text-2xl font-black amount-val text-emerald-700">${s.rec.toLocaleString()}</h2></div>
                <div class="bg-white p-5 rounded-3xl border-b-8 border-amber-500 shadow-xl text-center"><p class="text-[10px] font-black text-amber-600 uppercase">Visit Pending</p><h2 class="text-2xl font-black amount-val text-amber-700">${s.off.toLocaleString()}</h2></div>
                <div class="bg-white p-5 rounded-3xl border-b-8 border-rose-600 shadow-xl text-center"><p class="text-[10px] font-black text-rose-600 uppercase">Loan/Payable</p><h2 class="text-2xl font-black amount-val text-rose-700">${s.pay.toLocaleString()}</h2></div>`;
            
            updatePartyList();
        }

        function updateCatDropdown() {
            const catS = document.getElementById('tCat'); const cur = catS.value;
            catS.innerHTML = '<option value="">Select Category (Zaruri Hai)</option>';
            CODES.forEach(c => { if(db.visible[c]) catS.appendChild(new Option(db.labels[c], c)); });
            catS.value = cur;
        }

        document.getElementById('mainForm').onsubmit = (e) => {
            e.preventDefault();
            let mainAmt = parseFloat(document.getElementById('tAmount').value) || 0;
            let finalDesc = document.getElementById('tDesc').value;
            const cat = document.getElementById('tCat').value;
            
            if(cat === "OFFICE-BILL") {
                const miscAmt = parseFloat(document.getElementById('vMiscAmt').value) || 0;
                mainAmt += miscAmt;
                finalDesc = `[VISIT: ${document.getElementById('vMode').value} | P: ${document.getElementById('vPurpose').value} | Misc: ${miscAmt}] ` + finalDesc;
            }

            const entry = { id: editId || Date.now(), date: document.getElementById('tDate').value, party: document.getElementById('tParty').value, cat: cat, mode: document.getElementById('tMode').value, desc: finalDesc, amount: mainAmt };
            if(editId) db.entries[db.entries.findIndex(x => x.id === editId)] = entry; else db.entries.unshift(entry);
            if(!db.parties.includes(entry.party)) db.parties.push(entry.party);
            save(); resetForm();
        };

        function askConfigPass() { document.getElementById('passModal').classList.remove('hidden'); document.getElementById('adminPassInput').focus(); }
        function verifyConfigPass() {
            if(document.getElementById('adminPassInput').value === db.adminPass) { closeModal('passModal'); openConfig(); } 
            else { alert("Ghalat Password! Koshish Dobara Karein."); }
            document.getElementById('adminPassInput').value = "";
        }

        function openConfig() {
            const grid = document.getElementById('configGrid'); grid.innerHTML = '';
            document.getElementById('cfgAppTitle').value = db.title;
            document.getElementById('cfgAdminPass').value = db.adminPass;
            CODES.forEach(c => {
                grid.innerHTML += `<div class="flex items-center gap-4 bg-white p-4 rounded-3xl border-2 border-gray-100 shadow-sm">
                    <input type="checkbox" id="vis_${c}" ${db.visible[c]?'checked':''} class="w-7 h-7 accent-indigo-600">
                    <div class="flex-1">
                        <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest">${c}</span>
                        <input type="text" id="lbl_${c}" value="${db.labels[c]}" class="w-full text-sm font-black outline-none border-b-2 border-transparent focus:border-indigo-500">
                    </div>
                </div>`;
            });
            document.getElementById('configModal').classList.remove('hidden');
        }

        function saveConfig() {
            db.title = document.getElementById('cfgAppTitle').value;
            db.adminPass = document.getElementById('cfgAdminPass').value;
            CODES.forEach(c => { db.visible[c] = document.getElementById(`vis_${c}`).checked; db.labels[c] = document.getElementById(`lbl_${c}`).value; });
            save(); location.reload();
        }

        function editEntry(id) {
            const t = db.entries.find(x => x.id === id); editId = id;
            document.getElementById('tDate').value = t.date; document.getElementById('tParty').value = t.party; 
            document.getElementById('tCat').value = t.cat; document.getElementById('tMode').value = t.mode; 
            document.getElementById('tDesc').value = t.desc; document.getElementById('tAmount').value = t.amount;
            toggleVisitModule(t.cat); document.getElementById('cancelEdit').classList.remove('hidden');
            document.getElementById('saveBtn').innerText = "Update Karein"; window.scrollTo(0,0);
        }

        function deleteEntry(id) { if(confirm("Kya aap waqai mitaana chahte hain?")) { db.entries = db.entries.filter(x => x.id !== id); save(); } }
        function save() { localStorage.setItem('ikraam_v65_db', JSON.stringify(db)); render(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function resetForm() { editId = null; document.getElementById('mainForm').reset(); document.getElementById('cancelEdit').classList.add('hidden'); document.getElementById('visitBox').classList.add('hidden-module'); document.getElementById('saveBtn').innerText = "Save Record"; }
        function updatePartyList() { const pL = document.getElementById('partyList'); pL.innerHTML = ''; db.parties.forEach(p => pL.innerHTML += `<option value="${p}">`); }

        // SECURE BACKUP/IMPORT FIX
        function secureBackup() { 
            const key = prompt("Backup ka Password rakhein:"); 
            if(!key) return;
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(db), key).toString();
            const blob = new Blob([encrypted], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `Ikraam_Pro_Backup_${new Date().toISOString().slice(0,10)}.txt`; a.click();
        }

        function importSecureJSON(event) {
            const key = prompt("Backup ka Password dalein:");
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const decrypted = CryptoJS.AES.decrypt(e.target.result, key).toString(CryptoJS.enc.Utf8);
                    if(!decrypted) throw new Error("Wrong Key");
                    db = JSON.parse(decrypted);
                    save();
                    alert("Data kamyabi se import ho gaya!");
                    location.reload();
                } catch(err) { alert("Ghalat Password ya File!"); }
            };
            reader.readAsText(event.target.files[0]);
        }

        init();
    </script>
</body>
</html>